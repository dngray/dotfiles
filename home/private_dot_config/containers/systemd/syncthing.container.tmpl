[Unit]
Description=Podman syncthing.service
Wants=network-online.target
After=network-online.target

[Service]
Restart=on-failure
TimeoutStartSec=900

[Container]
Image=docker.io/syncthing/syncthing:latest
AutoUpdate=registry
PublishPort=127.0.0.1:8384:8384
PublishPort=22000:22000/tcp
PublishPort=22000:22000/udp
PublishPort=21027:21027/udp
UserNS=keep-id:uid={{ .chezmoi.uid }},gid={{ .chezmoi.gid }}
Volume=%h/.config/syncthing:/var/syncthing/config:Z

# Folders to share
{{- if (or (.state.private) (eq .profiles.main "profile11")) }}
{{-   $volumes := index (vault (printf "kv/users/%s/resources" .profiles.main)).data.data.containers.syncthing.volumes.all -}}
{{-   range $volumes }}
Volume={{ . }}
{{-   end }}
{{-   if (eq .chezmoi.hostname "cavern") }}
{{-     $volumes := index (vault (printf "kv/users/%s/resources" .profiles.main)).data.data.containers.syncthing.volumes.host1 -}}
{{-     range $volumes }}
Volume={{ . }}
{{-     end }}
{{-   end }}
{{    if (eq .chezmoi.hostname "snowfield") }}
{{-     $volumes := index (vault (printf "kv/users/%s/resources" .profiles.main)).data.data.containers.syncthing.volumes.host2 -}}
{{-     range $volumes }}
Volume={{ . }}
{{-     end }}
{{-   end }}
