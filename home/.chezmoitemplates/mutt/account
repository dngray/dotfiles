# vim: filetype=neomuttrc
{{- $type := (vault (printf "kv/users/%s/mail" .currVaultID)).data.data.type -}}
{{- $user := index (vault (printf "kv/users/%s/mail" .currVaultID)).data.data.mail .accIdx }}
{{- $aliases := ($user.alias) }}
# muttrc file for account {{ $user.accountName }}
set realname = "{{ $user.realName }}"
set from = "{{ (index ($aliases) 0) }}"
set hostname={{ $user.hostname }}
set my_sendmail_h="$HOME/.local/bin/sendmail {{ $user.accountName }}"
set my_sendmail_p="msmtp -a {{ $user.accountName }}"
set my_signature_p = ~/.config/mutt/signatures/{{ .accNum }}.signature
set my_signature_h = ~/.config/mutt/signatures/{{ .accNum }}_html.signature
{{- range $k, $aliases }}
alias alias{{ add $k 1 }} = {{ $user.realName}} <{{ . }}>
{{- end }}
set folder = ~/.local/share/mail/{{ $type }}/{{ $user.accountName }}
set header_cache = ~/.cache/mutt-wizard/{{ $user.accountName }}/headers
set message_cachedir = ~/.cache/mutt-wizard/{{ $user.accountName }}/bodies
set mbox_type = Maildir
{{ if eq (hasKey $user "keyID") true }}
set pgp_self_encrypt = yes
set pgp_default_key = {{ $user.keyID }}
{{- end }}

unbind index,pager h
macro index,pager r '<enter-command>set sendmail="$my_sendmail_p"<enter><enter-command>set signature="$my_signature_p"<enter><enter-command>set sig_dashes = yes<enter><reply>'
macro index,pager hr '<enter-command>set sendmail="$my_sendmail_h"<enter><enter-command>set signature="$my_signature_h"<enter><enter-command>set sig_dashes = no<enter><reply>'
macro index,pager m '<enter-command>set sendmail="$my_sendmail_p"<enter><enter-command>set signature="$my_signature_p"<enter><enter-command>set sig_dashes = yes<enter><mail>'
macro index,pager hm '<enter-command>set sendmail="$my_sendmail_h"<enter><enter-command>set signature="$my_signature_h"<enter><enter-command>set sig_dashes = no<enter><mail>'

bind index,pager gg noop
bind index,pager g noop
bind index,pager M noop
bind index,pager C noop
bind index gg first-entry
unmailboxes *

set spoolfile = "+Inbox"
set record = "+Sent"
set postponed = "+Drafts"
set trash = "+Trash"
mailboxes `find ~/.local/share/mail/{{ $type }}/{{ $user.accountName }} -type d -name cur | sort | sed -e 's:/cur/*$::' -e 's/ /\\ /g' | tr '\n' ' '`
macro index,pager gi "<change-folder>=Inbox<enter>" "go to inbox"
macro index,pager Mi ";<save-message>=Inbox<enter>" "move mail to inbox"
macro index,pager Ci ";<copy-message>=Inbox<enter>" "copy mail to inbox"
macro index,pager gs "<change-folder>=Sent<enter>" "go to sent"
macro index,pager Ms ";<save-message>=Sent<enter>" "move mail to sent"
macro index,pager Cs ";<copy-message>=Sent<enter>" "copy mail to sent"
macro index,pager gd "<change-folder>=Drafts<enter>" "go to drafts"
macro index,pager Md ";<save-message>=Drafts<enter>" "move mail to drafts"
macro index,pager Cd ";<copy-message>=Drafts<enter>" "copy mail to drafts"
macro index,pager gt "<change-folder>=Trash<enter>" "go to trash"
macro index,pager Mt ";<save-message>=Trash<enter>" "move mail to trash"
macro index,pager Ct ";<copy-message>=Trash<enter>" "copy mail to trash"
macro index,pager gS "<change-folder>=Spam<enter>" "go to spam"
macro index,pager MS ";<save-message>=Spam<enter>" "move mail to spam"
macro index,pager CS ";<copy-message>=Spam<enter>" "copy mail to spam"
macro index,pager gj "<change-folder>=Junk<enter>" "go to junk"
macro index,pager Mj ";<save-message>=Junk<enter>" "move mail to junk"
macro index,pager Cj ";<copy-message>=Junk<enter>" "copy mail to junk"

macro index,pager v ";<decrypt-copy>~/.local/share/mail/{{ $type }}/decrypted<enter>" "Save decrypted copy"
macro index,pager gv "<change-folder>~/.local/share/mail/{{ $type }}/decrypted<enter>" "go to decrypted dump"


bind editor <Tab> complete-query
{{- if eq .currVaultID .vaultID1 }}
# https://khard.readthedocs.io/en/latest/scripting.html
bind editor ^T    complete
unset query_command
set query_command= "khard email --parsable --search-in-source-files %s -a Personal"
macro index,pager Z \
  "<pipe-message>khard add-email<return>" \
  "add the sender email address to khard"
{{- else -}}
# Unbind khard
unset query_command
set query_command= "khard email --parsable --search-in-source-files %s -a Local"
{{- end }}
unmacro index,pager Z
